using System;
using System.Collections;
using System.Collections.Generic;
using UnityEngine;
using UnityEngine.UI;

public class Exploitation : MonoBehaviour
{
    public Expedition expedition;
    [SerializeField] private GameObject slot;
    private TuileManager tuileExploitee;
    public List<SlotExploit> listeSlots = new List<SlotExploit>();
    [SerializeField] private PanelGainRessources panelGainRessource;
    private Production gainRessource;
    [SerializeField] private GameObject zoneSlots;

    // Start is called before the first frame update
    void Start()
    {
        TourParTour.Defaut.eventNouveauTour.AddListener(MiseAJourProduction);
        slot.SetActive(false);
    }

    // Update is called once per frame
    void Update()
    {
        
    }
    private void OnEnable()
    {
        MiseAJourSlots();
    }

    private void OnDestroy()
    {
        if(tuileExploitee)
        {
            expedition.tribu.stockRessources.RetirerGain(GainRessource);
        }
    }

    private void MiseAJourProduction()
    {
        MiseAJourSlots();
        expedition.tribu.stockRessources.AjouterGain(GainRessource);
    }

    private void MiseAJourSlots()
    {
        if(tuileExploitee)
        {
            //Vérifie que le nombre de slot est le bon et 
            if (tuileExploitee.productionTuile.NbrSlot != listeSlots.Count)
            {
                GenererSlots(tuileExploitee.productionTuile.NbrSlot - listeSlots.Count);
            }
        }
        MiseAJourInterdictions();
    }

    private void MiseAJourInterdictions()
    {
        if(tuileExploitee)
        {
            foreach (Revendication revendicateur in tuileExploitee.revendication.revendicateurs)
            {
                if (revendicateur != expedition.tribu.revendication)
                {
                    if (revendicateur.EstTribu)
                    {
                        Tribu tribu = (Tribu)revendicateur.parent;
                        foreach (Exploitation exploit in tribu.expedition.listeExploitations)
                        {
                            if (exploit.tuileExploitee == tuileExploitee)
                            {
                                int slotsAInterdire = 0;
                                foreach (SlotExploit slot in exploit.listeSlots)
                                {
                                    if (slot.estOccupe) slotsAInterdire++;
                                }
                                if (slotsAInterdire > 0)
                                {
                                    InterdireSlots(slotsAInterdire, "<color=#" + ColorUtility.ToHtmlStringRGBA(ListeCouleurs.Defaut.couleurAlerteTexteInterface)
                                        + ">Une autre tribu exploite déjà ce slot<color=\"white\">");
                                }
                            }
                        }
                    }
                }
            }
        }
    }

    private void InterdireSlots(int nombre, string message)
    {
        ReiniAutorisationSlots();
        for (int i = 0; i < listeSlots.Count; i++)
        {
            if(nombre > 0)
            {
                listeSlots[i].InterdireSlot(message);
                nombre--;
            }
        }
    }

    private void ReiniAutorisationSlots()
    {
        foreach (SlotExploit slot in listeSlots)
        {
            slot.AutoriserSlot();
        }
    }

    //Fait office d'initialisateur
    public TuileManager TuileExploitee
    {
        set
        {
            tuileExploitee = value;
            Vector3 position = tuileExploitee.transform.position;
            position.z = transform.position.z;
            transform.position = position;
            expedition.tribu.stockRessources.AjouterGain(GainRessource);
            GenererSlots();
        }
    }

    private void GenererSlots()
    {
        bool tuileActuelleDuneAutreTribu = false;
        foreach (Revendication revendicateur in tuileExploitee.revendication.revendicateurs)
        {
            if (revendicateur.EstTribu && revendicateur != expedition.tribu.revendication)
            {
                Tribu tribu = (Tribu)revendicateur.parent;
                if (tuileExploitee == tribu.tuileActuelle)
                {
                    tuileActuelleDuneAutreTribu = true;
                    break;
                }
            }
        }

        if (expedition.tribu.tuileActuelle != tuileExploitee && !tuileActuelleDuneAutreTribu)
        {
                int nbrSlots = tuileExploitee.productionTuile.NbrSlot;
            for (int i = 0; i < nbrSlots; i++)
            {
                GameObject nvSlot = Instantiate(slot, zoneSlots.transform);
                SlotExploit slotExploit = nvSlot.GetComponent<SlotExploit>();
                listeSlots.Add(slotExploit);
                slotExploit.exploitation = this;
            }
        }

        MiseAJourInterdictions();
    }

    private void GenererSlots(int nbrSlots)
    {
        bool tuileActuelleDuneAutreTribu = false;
        foreach (Revendication revendicateur in tuileExploitee.revendication.revendicateurs)
        {
            if (revendicateur.EstTribu && revendicateur != expedition.tribu.revendication)
            {   
                Tribu tribu = (Tribu)revendicateur.parent;
                if (tuileExploitee == tribu.tuileActuelle)
                {
                    tuileActuelleDuneAutreTribu = true;
                    break;
                }
            }
        }

        if (expedition.tribu.tuileActuelle != tuileExploitee && !tuileActuelleDuneAutreTribu)
        {
            if (nbrSlots > 0) //si le nobre de slots à rajouter est positif, on instantie ces slots
            {
                for (int i = 0; i < nbrSlots; i++)
                {
                    GameObject nvSlot = Instantiate(slot, zoneSlots.transform);
                    SlotExploit slotExploit = nvSlot.GetComponent<SlotExploit>();
                    listeSlots.Add(slotExploit);
                    slotExploit.exploitation = this;
                }
            }
            else //sinon on supprime des slots
            {
                for (int i = 0; i < Math.Abs(nbrSlots); i++)
                {
                    if(listeSlots.Count > 1)
                    {
                        Destroy(listeSlots[listeSlots.Count - 1].gameObject);
                        listeSlots.RemoveAt(listeSlots.Count - 1);
                    }
                    else
                    {
                        Destroy(listeSlots[0].gameObject);
                        listeSlots.RemoveAt(0);
                    }
                }
            }
        }
    }

    public void AfficherGainRessource()
    {
        panelGainRessource.AfficherRessources(GainRessource);
        expedition.tribu.stockRessources.AjouterGain(GainRessource);
    }

    private Production GainRessource
    {
        get
        {
            if(gainRessource == null)
            {
                gainRessource = ScriptableObject.CreateInstance<Production>();
                gainRessource.gains = new float[ListeRessources.Defaut.listeDesRessources.Length];
            }
            gainRessource.Clear();
            if (tuileExploitee != expedition.tribu.tuileActuelle)
            {
                int slotsOccupes = 0;
                int slotsBonusOutil = 0;
                foreach (SlotExploit slot in listeSlots)
                {
                    if (slot.estOccupe)
                    {
                        slotsOccupes++;
                    }
                }
                foreach (SlotExploit slot in listeSlots)
                {
                    if (slot.bonusOutil)
                    {
                        slotsBonusOutil++;
                    }
                }
                for (int i = 0; i < gainRessource.gains.Length; i++)
                {
                    gainRessource.gains[i] += tuileExploitee.productionTuile.Production.gains[i] * slotsOccupes;
                    gainRessource.gains[i] += tuileExploitee.productionTuile.BonusOutil.gains[i] * slotsBonusOutil;
                }
                if (ListeRessources.Defaut) gainRessource.gains[ListeRessources.Defaut.TrouverIndexRessource("Outil")] -= slotsBonusOutil;
                return gainRessource;
            }
            else
            {
                for (int i = 0; i < gainRessource.gains.Length; i++)
                {
                    gainRessource.gains[i] += tuileExploitee.productionTuile.Production.gains[i];
                }
                return gainRessource;
            }
        }
    }
}
